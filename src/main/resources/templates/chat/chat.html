<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>Chat | Trocabook</title>
</head>
<body>
<div class="container">
    <header>
        <div class="wrapper">
            <table class="cabecalho">
                <tr>
                    <th id="cabecalhoelementos">
                        <a href="/"><img src="/img/Design%20sem%20nome%20(7).svg"></a>
                        <div class="autocomplete-wrapper">
                            <input type="text" style="width: 100%; height: 35px;" id="pesquisa" placeholder="Pesquisar">
                            <div id="resultadosPesquisa" class="sugestoes-autocomplete"></div>
                        </div>

                        <select id="inputCategoria" class="form-control" style="width: 200px; height:37px; margin-left: 15px;">
                            <option selected>Categoria...</option>
                            <option>A칞칚o</option>
                            <option>Romance</option>
                            <option>Literatura</option>
                            <option>L칩gica de Programa칞칚o</option>
                            <option>Direito</option>
                            <option>Suspense</option>
                            <option>Fic칞칚o Cient칤fica</option>
                        </select>

                        <th:block sec:authorize="isAuthenticated()">
                            <a class="anunciar-livro4" href="/AnunciarLivro">Anunciar Livro</a>
                            <a class="meus-livros4" href="/MeusLivros">Meus Livros</a>
                            <form th:action="@{/logout}" method="post" style="display: inline;">
                                <button type="submit" id="deslogar">Sair</button>
                            </form>
                        </th:block>
                    </th>
                </tr>
            </table>
        </div>
    </header>

    <div vw class="enabled">
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
        new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>

    <main class="main-container">
        <aside class="chat-sidebar">
            <h2>Chat</h2>
            <input type="text" placeholder="Pesquisar conversas">
            <ul class="chat-list">
                <li class="active"><img th:src="${usuarioNegociante.foto}" alt="User"><span th:text="${usuarioNegociante.nmUsuario}"></span></li>
            </ul>
        </aside>

        <section class="chat-window">
            <div class="chat-info">
                <p style="text-align: center; color: #888; margin-bottom: 20px;">Lembre-se de trocar mensagens com respeito e cordialidade.<br>Desejamos uma excelente negocia칞칚o :D</p>
            </div>

            <div class="messages" id="messagesContainer">
                <div th:each="msg : ${mensagens}"
                     th:attr="data-id=${msg.id}, title=${msg.conteudo}"
                     th:class="'message ' + (${msg.cdUsuarioRemetente == usuarioLogado.cdUsuario} ? 'user' : 'negociador')">

                    <!-- Menu de op칞칫es s칩 aparece nas mensagens do usu치rio logado -->
                    <div th:if="${msg.cdUsuarioRemetente == usuarioLogado.cdUsuario}" class="menu-opcoes">
                        <i class="fa-solid fa-ellipsis-vertical" onclick="abrirMenu(this)"></i>
                        <div class="menu-dropdown">
                            <button onclick="editarMensagem(this)">Editar</button>
                            <button onclick="excluirMensagem(this)">Excluir</button>
                        </div>
                    </div>

                    <!-- Foto do outro usu치rio (s칩 aparece nas mensagens recebidas) -->
                    <img th:if="${msg.cdUsuarioRemetente != usuarioLogado.cdUsuario}"
                         th:src="${usuarioNegociante.foto}" alt="Negociante">

                    <p th:text="${msg.conteudo}"></p>
                </div>
            </div>


            <form id="chatForm" class="message-input">
                <input type="hidden" id="cdUsuarioLivro" th:value="${mensagemDTO.cdUsuarioLivro}">
                <input type="hidden" id="cdUsuarioRemetente" th:value="${mensagemDTO.cdUsuarioRemetente}">
                <input type="hidden" id="cdUsuarioDestinatario" th:value="${mensagemDTO.cdUsuarioDestinatario}">
                <input type="text" id="conteudo" placeholder="Mensagem">
                <button type="submit"><img src="/img/aviao.png" alt="Enviar"></button>
            </form>
        </section>

        <aside class="book-info">
            <img th:src="${livro.capa}" alt="Capa O Pequeno Pr칤ncipe">
            <p><strong>T칤tulo da obra:</strong><br><b><span th:text="${livro.nmLivro}"></span></b></p>
            <p><strong>Data de publica칞칚o:</strong><br>15 de novembro de 2024</p>
            <p>Livro em 칩timo estado, disponibilizo para vendas</p>
        </aside>
    </main>

    <script>
        const cdUsuarioLivro = parseInt(document.getElementById('cdUsuarioLivro').value);
        const cdUsuarioRemetente = parseInt(document.getElementById('cdUsuarioRemetente').value);
        const cdUsuarioDestinatario = parseInt(document.getElementById('cdUsuarioDestinatario').value);
        const container = document.getElementById('messagesContainer');
        let ultimaQuantidade = container.children.length;

        // Fun칞칚o para renderizar uma mensagem
        function adicionarMensagemNoContainer(msg) {
                const classe = msg.cdUsuarioRemetente === cdUsuarioRemetente ? 'user' : 'negociador';
                const div = document.createElement('div');
                div.className = `message ${classe}`;
                div.setAttribute('data-id', msg.id || ''); // adiciona o ID para edi칞칚o/exclus칚o

                // Se for mensagem do outro usu치rio, mostra a imagem dele
                const img = msg.cdUsuarioRemetente === cdUsuarioRemetente
                    ? ''
                    : `<img src="${document.querySelector('.chat-list img')?.src || '/img/user.png'}" alt="Negociante">`;

                // Se for mensagem do usu치rio logado, adiciona o menu de op칞칫es
                const menu = msg.cdUsuarioRemetente === cdUsuarioRemetente
                    ? `
                        <div class="menu-opcoes">
                            <i class="fa-solid fa-ellipsis-vertical" onclick="abrirMenu(this)"></i>
                            <div class="menu-dropdown">
                                <button onclick="editarMensagem(this)">Editar</button>
                                <button onclick="excluirMensagem(this)">Excluir</button>
                            </div>
                        </div>
                      `
                    : '';

                // Monta o HTML da mensagem
                div.innerHTML = `
                    ${menu}
                    ${img}
                    <p>${msg.conteudo}</p>
                `;

                // Adiciona ao container
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                ultimaQuantidade++;
            }


        // Envio de mensagem
        document.querySelector('#chatForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const conteudo = document.getElementById('conteudo').value.trim();
            if (!conteudo) return;

            const mensagem = {
                cdUsuarioLivro,
                cdUsuarioRemetente,
                cdUsuarioDestinatario,
                conteudo
            };

            const resposta = await fetch('/chat/mensagens', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(mensagem)
            });

            const data = await resposta.json();
            if (data.status === 'success') {
                adicionarMensagemNoContainer(data.data);
                document.getElementById('conteudo').value = '';
            }
        });

        // Atualiza칞칚o autom치tica de mensagens (polling)
        async function atualizarMensagens() {
            const resp = await fetch(`/chat/mensagens/atualizar?usuarioLivro=${cdUsuarioLivro}&remetente=${cdUsuarioRemetente}&destinatario=${cdUsuarioDestinatario}`);
            const data = await resp.json();

            if (data.status === 'success') {
                if (data.data.length > ultimaQuantidade) {
                    const novas = data.data.slice(ultimaQuantidade);
                    novas.forEach(adicionarMensagemNoContainer);
                }
            }
        }

        // Atualiza a cada 4 segundos
        setInterval(atualizarMensagens, 4000);

        function abrirMenu(icon) {
            const menu = icon.nextElementSibling;
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // 游댳 Edi칞칚o de mensagem
        async function editarMensagem(botao) {
            const msgDiv = botao.closest('.message');
            const idMensagem = msgDiv.getAttribute('data-id');
            const p = msgDiv.querySelector('p');

            const novoConteudo = prompt("Editar mensagem:", p.textContent);
            if (novoConteudo === null || novoConteudo.trim() === "") return;

            const resposta = await fetch(`/chat/mensagens/${idMensagem}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({conteudo: novoConteudo})
            });

            const data = await resposta.json();
            if (data.status === 'success') {
                p.textContent = novoConteudo;
                alert('Mensagem alterada com sucesso!');
            } else {
                alert('Erro ao alterar mensagem.');
            }
        }

        // 游댳 Exclus칚o de mensagem
        async function excluirMensagem(botao) {
            const msgDiv = botao.closest('.message');
            const idMensagem = msgDiv.getAttribute('data-id');

            if (!confirm("Deseja realmente excluir esta mensagem?")) return;

            const resposta = await fetch(`/chat/mensagens/${idMensagem}`, { method: 'DELETE' });
            const data = await resposta.json();

            if (data.status === 'success') {
                msgDiv.remove();
            } else {
                alert('Erro ao excluir mensagem.');
            }
        }

    </script>

    <footer>
        <div class="rodapenovo">
            <a href="/static"><img src="/img/Design%20sem%20nome.svg"></a>
            <a href="/sobreNos"><p>Conhe칞a nosso incr칤vel projeto <br>de incentivo a reutiliza칞칚o</p></a>
            <a href="/ajuda"><p>Central de ajuda</p></a>
            <small>춸 2025 Sistema Trocabook<br>Todos os direitos reservados</small>
        </div>
    </footer>
</div>
</body>
<script src="/js/fetch.js"></script>
</html>