<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css"/>
    <title>Criar novo anuncio | Trocabook</title>
</head>
<body>
<div class="container">
    <header>
        <div class="wrapper">
            <table class="cabecalho"><tr>
                <th id="cabecalhoelementos">
                    <a href="/"><img src="/img/Design sem nome (7).svg"></a>
                    <div class="autocomplete-wrapper">
                        <input type="text" style="width: 100%; height: 35px;" id="pesquisa" placeholder="Pesquisar">
                        <div id="resultadosPesquisa" class="sugestoes-autocomplete"></div>
                    </div>

                    <select id="inputCategoria" class="form-control" style="width: 200px; height:37px; margin-left: 15px;">
                        <option selected>Categoria...</option>
                        <option>A√ß√£o</option>
                        <option>Romance</option>
                        <option>Literatura</option>
                        <option>L√≥gica de Programa√ß√£o</option>
                        <option>Direito</option>
                        <option>Suspense</option>
                        <option>Fic√ß√£o Cient√≠fica</option>
                    </select>

                    <th:block sec:authorize="isAuthenticated()">
                        <a class="anunciar-livro4" href="/AnunciarLivro">Anunciar Livro</a>
                        <a class="meus-livros4" href="/MeusLivros">Meus Livros</a>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" id="deslogar">Sair</button>
                        </form>
                    </th:block>

                    <th:block sec:authorize="!isAuthenticated()">
                        <a href="/login" id="loginbotao"><button type="submit" style="width: 150px; height:37px;">Fazer login</button></a>
                    </th:block>
                </th>
            </tr>
            </table>
        </div>
    </header>
    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
            <div class="vw-plugin-top-wrapper"></div>
        </div>
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
        new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>
    <div class="paganunciar">
        <div class="anuncio">
            <h1>Crie o seu anuncio</h1>
            <form enctype="multipart/form-data" th:object="${livro}">

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <input type="text" th:field="*{nmLivro}" style="width: 45%; height: 33px;" id="titulo" name="nmLivro" placeholder="Titulo do livro"><br>
                <div th:if="${#fields.hasErrors('nmLivro')}" th:errors="*{nmLivro}"></div>
                <!--
                <input type="text" th:field="*{anoPublicacao}" style="width: 45%; height: 33px;" id="ano" name="anoPublicacao" placeholder="Ano de publica√ß√£o"><br>
                <div th:if="${#fields.hasErrors('anoPublicacao')}" th:errors="*{anoPublicacao}"></div>
                <input type="text" style="width: 45%; height: 200px;" placeholder="Descreva o livro, estado de conserva√ß√£o e outros detalhes que queira incluir"><br><br>
                <p>Selecione o tipo de an√∫ncio:</p><br>
                <select name="tipoNegociacao" class="categoriaNegociacao">
                    <option value="">-- Selecione --</option>
                    <option value="TROCA">Troca</option>
                    <option value="VENDA">Venda</option>
                    <option value="AMBOS">Ambos</option>
                </select>
                <div th:if="${tipoErro != null}" th:text="${tipoErro}"></div>
                <p>Carregue a capa do seu livro aqui:</p>
                <input type="file" id="capaLivro" name="capaLivro" accept="image/*" style="width: 470px; height: 140px; border-style: dotted; padding-top: 10px;"><br>
                <div th:if="${capaErro != null}" th:text="${capaErro}"></div>
                <button type="submit">Anunciar</button>
                -->
            </form>
            <button id="buscarLivro" onclick="buscarLivro()" type="button">Buscar</button>
            <img id="capaLivro">
            <input type="text" id="data-publicacao" readonly>
            <div id="resultadosApi" style="margin-top: 20px;">
                <h3>Resultados encontrados</h3>
                <div id="livrosApiLista" class="livros-grid"></div>
            </div>

        </div>
    </div>

    <footer>
        <div class="rodapenovo">
            <a href="/"><img src="/img/Design sem nome.svg"></a>
            <a href="/sobreNos"><p>Conhe√ßa nosso incr√≠vel projeto <br>de incentivo a reutiliza√ß√£o</p></a>
            <a href="/ajuda"><p>Central de ajuda</p></a>
            <small>¬© 2025 Sistema Trocabook<br>Todos os direitos reservados</small>
        </div>
    </footer>
</div>
</body>
<script>
    function buscarLivro(){
        const titulo = document.getElementById("titulo").value;
        const csrfToken = document.querySelector('input[name="_csrf"]').value;

        fetch("/buscar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": csrfToken
            },
            body: JSON.stringify({ titulo: titulo })
        })
            .then(res => {
                if (!res.ok) throw new Error("Erro ao buscar livro");
                return res.json();
            })
            .then(lista => {
                const div = document.getElementById("livrosApiLista");
                div.innerHTML = ""; // limpa

                if (!lista || lista.length === 0) {
                    div.innerHTML = "<p>Nenhum livro encontrado üò•</p>";
                    return;
                }

                lista.forEach(livro => {
                    const card = document.createElement("div");
                    card.className = "livro-card";
                    card.style.cursor = "pointer";

                    card.innerHTML = `
                <img src="${livro.thumbnailUrl ?? '/img/default-capa.png'}"
                     alt="Capa" class="capaLivros">
                <p>${livro.titulo}</p>
                <small>${livro.dataPublicacao ?? "Sem data"}</small>
            `;

                    // ‚úÖ Quando clicar no livro, preenche os campos
                    card.addEventListener("click", () => {
                        document.getElementById("titulo").value = livro.titulo;
                        document.getElementById("capaLivro").src = livro.thumbnailUrl ?? "/img/default-capa.png";
                        document.getElementById("data-publicacao").value = livro.dataPublicacao ?? "";
                    });

                    div.appendChild(card);
                });
            })
            .catch(err => alert(err.message));
    }



</script>
</html>