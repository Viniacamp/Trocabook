<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css"/>
    <link rel="stylesheet" type="text/css" href="/css/anunciarLivroApi.css"/>
    <title>Criar novo anuncio | Trocabook</title>
</head>
<body>
<div class="container">
    <header>
        <div class="wrapper">
            <table class="cabecalho"><tr>
                <th id="cabecalhoelementos">
                    <a href="/"><img src="/img/Design sem nome (7).svg"></a>
                    <div class="autocomplete-wrapper">
                        <input type="text" style="width: 100%; height: 35px;" id="pesquisa" placeholder="Pesquisar">
                        <div id="resultadosPesquisa" class="sugestoes-autocomplete"></div>
                    </div>

                    <select id="inputCategoria" class="form-control" style="width: 200px; height:37px; margin-left: 15px;">
                        <option selected>Categoria...</option>
                        <option>A√ß√£o</option>
                        <option>Romance</option>
                        <option>Literatura</option>
                        <option>L√≥gica de Programa√ß√£o</option>
                        <option>Direito</option>
                        <option>Suspense</option>
                        <option>Fic√ß√£o Cient√≠fica</option>
                    </select>

                    <th:block sec:authorize="isAuthenticated()">
                        <a class="anunciar-livro4" href="/AnunciarLivro">Anunciar Livro</a>
                        <a class="meus-livros4" href="/MeusLivros">Meus Livros</a>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" id="deslogar">Sair</button>
                        </form>
                    </th:block>

                    <th:block sec:authorize="!isAuthenticated()">
                        <a href="/login" id="loginbotao"><button type="submit" style="width: 150px; height:37px;">Fazer login</button></a>
                    </th:block>
                </th>
            </tr>
            </table>
        </div>
    </header>
    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
            <div class="vw-plugin-top-wrapper"></div>
        </div>
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
        new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>
    <div class="paganunciar">
        <div class="anuncio">
            <h1>Crie o seu an√∫ncio</h1>

            <div class="busca-livro-container">
                <input type="text" id="tituloBuscado" placeholder="Digite o t√≠tulo do livro a ser anunciado">
                <button id="buscarLivro" onclick="buscarLivro()" type="button">Buscar</button>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <!-- Resultados da API -->
                <div id="resultadosLivros" class="sugestoes-autocomplete"></div>
            </div>
            <form th:object="${livroDTO}" th:action="@{/salvar}" method="post" class="form-anuncio">
                <div class="livro-detalhes">

                    <label for="capaLivro" class="label-principal">Capa do Livro:</label>
                    <img id="capaLivro" class="capaLivro" style="display:none;">

                    <label for="titulo">T√≠tulo:</label>
                    <!-- Agora √© edit√°vel -->
                    <input type="text" id="titulo" th:field="*{titulo}" placeholder="T√≠tulo do livro">

                    <label for="dataPublicacao">Data de Publica√ß√£o:</label>
                    <input type="date" id="dataPublicacao" th:field="*{dataPublicacao}">

                    <label>Autores:</label>
                    <div id="autores" class="tags-container">
                        <!-- Ao preencher via JS, criaremos inputs escondidos tamb√©m -->
                        <div th:each="autor, i : *{autores}">
                            <input type="hidden" th:field="*{autores[__${i.index}__]}" th:value="${autor}">
                            <span th:text="${autor}"></span>
                        </div>
                    </div>

                    <label>Categorias:</label>
                    <div id="categorias" class="tags-container">
                        <div th:each="categoria, i : *{categorias}">
                            <input type="hidden" th:field="*{categorias[__${i.index}__]}" th:value="${categoria}">
                            <span th:text="${categoria}"></span>
                        </div>
                    </div>

                    <label for="descricao">Descri√ß√£o:</label>
                    <textarea id="descricao" name="descricao" placeholder="Descreva o livro, estado de conserva√ß√£o e outros detalhes que queira incluir"></textarea>

                    <label for="tipoNegociacao">Tipo de negocia√ß√£o:</label>
                    <select id="tipoNegociacao" th:field="*{tipoNegociacao}">
                        <option value="">Selecione...</option>
                        <option value="TROCA">Troca</option>
                        <option value="VENDA">Venda</option>
                        <option value="AMBOS">Ambos</option>
                    </select>

                    <button type="submit" class="btn-criar">Criar An√∫ncio</button>
                </div>
            </form>



        </div>
    </div>




    <footer>
        <div class="rodapenovo">
            <a href="/"><img src="/img/Design sem nome.svg"></a>
            <a href="/sobreNos"><p>Conhe√ßa nosso incr√≠vel projeto <br>de incentivo a reutiliza√ß√£o</p></a>
            <a href="/ajuda"><p>Central de ajuda</p></a>
            <small>¬© 2025 Sistema Trocabook<br>Todos os direitos reservados</small>
        </div>
    </footer>
</div>
</body>
<script>
    const inputBusca = document.getElementById("tituloBuscado");
    const resultados = document.getElementById("resultadosLivros");
    const container = document.querySelector(".busca-livro-container");
    const botaoBuscar = document.getElementById("buscarLivro");


    document.addEventListener("click", function (event) {
        if (
            container &&
            resultados &&
            !container.contains(event.target) &&
            event.target !== botaoBuscar
        ) {
            resultados.style.display = "none";
        }
    });


    inputBusca.addEventListener("focus", function () {
        if (resultados && resultados.innerHTML.trim() !== "") {
            resultados.style.display = "block";
        }
    });


    botaoBuscar.addEventListener("click", function (event) {
        event.stopPropagation(); // üî• impede o clique de propagar
    });

    function buscarLivro() {
        const titulo = document.getElementById("tituloBuscado").value;
        const csrfToken = document.querySelector('input[name="_csrf"]').value;
        const divResultados = document.getElementById("resultadosLivros");

        divResultados.innerHTML = "";
        divResultados.style.display = "block";

        if (titulo.trim().length === 0) return;

        fetch("/buscar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": csrfToken
            },
            body: JSON.stringify({ titulo })
        })
            .then(res => {
                if (!res.ok) throw new Error("Erro ao buscar livro");
                return res.json();
            })
            .then(livros => {
                if (!livros || livros.length === 0) {
                    divResultados.innerHTML = "<p>Nenhum livro encontrado üò•</p>";
                    return;
                }

                livros.forEach(livro => {
                    const link = document.createElement("a");
                    link.href = "#";
                    link.addEventListener("click", (e) => {
                        e.preventDefault();
                        preencherCampos(livro);
                        divResultados.innerHTML = ""; // limpa lista ap√≥s sele√ß√£o
                    });

                    const capa = document.createElement("img");
                    capa.src = livro.thumbnailUrl || "/img/default-capa.png";
                    capa.className = "livro-capa";

                    const texto = document.createElement("p");
                    texto.innerText = livro.titulo;

                    link.appendChild(capa);
                    link.appendChild(texto);
                    divResultados.appendChild(link);
                });
            })
            .catch(err => {
                divResultados.innerHTML = `<p>Erro: ${err.message}</p>`;
            });
    }

    function preencherCampos(livro) {
        document.getElementById("titulo").value = livro.titulo || "";
        document.getElementById("capaLivro").src = livro.thumbnailUrl || "/img/default-capa.png";
        document.getElementById("capaLivro").style.display = "block";
        document.getElementById("dataPublicacao").value = livro.dataPublicacao || "";

        // ======== AUTORES ========
        const autoresDiv = document.getElementById("autores");
        autoresDiv.innerHTML = "";
        livro.autores.forEach((autor, i) => {
            const span = document.createElement("span");
            span.innerText = autor;

            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = `autores[${i}]`;
            hiddenInput.value = autor;

            autoresDiv.appendChild(span);
            autoresDiv.appendChild(hiddenInput);
        });

        // ======== CATEGORIAS ========
        const categoriasDiv = document.getElementById("categorias");
        categoriasDiv.innerHTML = "";
        livro.categorias.forEach((categoria, i) => {
            const span = document.createElement("span");
            span.innerText = categoria;

            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = `categorias[${i}]`;
            hiddenInput.value = categoria;

            categoriasDiv.appendChild(span);
            categoriasDiv.appendChild(hiddenInput);
        });
    }

</script>

</html>